<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <title>Lucky Dog DB Console</title>
  <style>
    :root {
      color-scheme: light dark;
      font-family: 'Segoe UI', Arial, sans-serif;
    }

    body {
      margin: 0;
      background: #f0f2f5;
      color: #1f1f1f;
      display: flex;
      justify-content: center;
    }

    main {
      width: min(720px, 100%);
      padding: 1.25rem 1.5rem 1.5rem;
      margin: 1rem;
      background: #ffffff;
      border-radius: 10px;
      box-shadow: 0 4px 18px rgba(0, 0, 0, 0.08);
      display: grid;
      gap: 1rem;
    }

    h1 {
      font-size: 1.5rem;
      margin: 0;
    }

    h2 {
      font-size: 1rem;
      margin: 0 0 0.75rem;
      color: #4a4a4a;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    section {
      background: #fafafa;
      border-radius: 8px;
      padding: 0.9rem 1rem;
      display: grid;
      gap: 0.75rem;
      border: 1px solid rgba(0, 0, 0, 0.05);
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 1rem;
    }

    .actions {
      display: grid;
      gap: 0.4rem;
    }

    .actions button {
      justify-self: stretch;
    }

    .field {
      display: grid;
      gap: 0.3rem;
    }

    .inline {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 0.4rem;
      align-items: center;
    }

    label {
      font-size: 0.85rem;
      color: #5a5a5a;
    }

    input {
      padding: 0.45rem 0.6rem;
      border: 1px solid #c9c9c9;
      border-radius: 6px;
      font-size: 0.95rem;
    }

    button {
      padding: 0.45rem 0.85rem;
      border: none;
      border-radius: 6px;
      background: linear-gradient(135deg, #2563eb, #1d4ed8);
      color: #fff;
      font-weight: 600;
      font-size: 0.95rem;
      cursor: pointer;
      transition:
        box-shadow 0.2s ease,
        transform 0.1s ease;
    }

    button:hover {
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.25);
      transform: translateY(-1px);
    }

    pre {
      background: #1e1e1e;
      color: #f8f8f2;
      padding: 0.9rem;
      border-radius: 6px;
      margin: 0;
      min-height: 140px;
      overflow-x: auto;
      font-size: 0.9rem;
    }

    /* Work Progress Styles */
    .loading {
      text-align: center;
      color: #666;
      font-style: italic;
    }

    .progress-container {
      display: grid;
      gap: 1rem;
    }

    .progress-bar {
      background: #e5e7eb;
      border-radius: 8px;
      overflow: hidden;
      height: 32px;
      position: relative;
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .progress-segments {
      display: flex;
      height: 100%;
    }

    .progress-segment {
      transition: width 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: 600;
      color: white;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
    }

    .progress-checked {
      background: linear-gradient(135deg, #10b981, #059669);
    }

    .progress-checking {
      background: linear-gradient(135deg, #f59e0b, #d97706);
    }

    .progress-uncheck {
      background: linear-gradient(135deg, #ef4444, #dc2626);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 0.75rem;
      margin-top: 1rem;
    }

    .stat-card {
      background: white;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      padding: 0.75rem;
      text-align: center;
    }

    .stat-number {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 0.25rem;
    }

    .stat-label {
      font-size: 0.75rem;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .stat-checked .stat-number {
      color: #059669;
    }

    .stat-checking .stat-number {
      color: #d97706;
    }

    .stat-uncheck .stat-number {
      color: #dc2626;
    }

    .stat-total .stat-number {
      color: #374151;
    }

    .password-found {
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
      text-align: center;
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 10px 25px rgba(16, 185, 129, 0.3);
      animation: pulse 2s infinite;
    }

    .password-found h3 {
      font-size: 2rem;
      margin: 0 0 0.5rem 0;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .password-found p {
      font-size: 1.1rem;
      margin: 0;
      opacity: 0.9;
    }

    @keyframes pulse {

      0%,
      100% {
        transform: scale(1);
      }

      50% {
        transform: scale(1.02);
      }
    }

    .last-updated {
      text-align: center;
      font-size: 0.8rem;
      color: #6b7280;
      margin-top: 1rem;
    }

    @media (max-width: 480px) {
      main {
        padding: 1rem;
        margin: 0.5rem;
      }

      .inline {
        grid-template-columns: 1fr;
      }

      button {
        width: 100%;
      }

      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .password-found h3 {
        font-size: 1.5rem;
      }

      .password-found p {
        font-size: 1rem;
      }
    }
  </style>
</head>

<body>
  <main>
    <h1>Lucky Dog API Console</h1>

    <div class="grid">
      <section>
        <h2>Quick Actions</h2>
        <div class="actions">
          <button data-action="count">Get Count</button>
          <button data-action="random">Random Record</button>
          <button data-action="health">Health Check</button>
          <button data-action="stats">Work Stats</button>
          <button id="reset-found-btn" data-action="reset-found" style="background: linear-gradient(135deg, #dc2626, #b91c1c); display: none;">Reset Password Found</button>
        </div>
      </section>

      <section>
        <h2>Lookup</h2>

        <div class="field">
          <label for="id-input">Record ID</label>
          <div class="inline">
            <input id="id-input" type="number" min="1" placeholder="ID" />
            <button data-action="by-id">Find</button>
          </div>
        </div>

        <div class="field">
          <label for="pwd-input">Password</label>
          <div class="inline">
            <input id="pwd-input" type="text" maxlength="10" placeholder="pwd" />
            <button data-action="by-pwd">Find</button>
          </div>
        </div>
      </section>

    </div>

    <section>
      <h2>Work Progress</h2>
      <div id="work-progress">
        <div class="loading">Loading work stats...</div>
      </div>
    </section>

    <section>
      <h2>API Result</h2>
      <pre id="output">Click a button to fetch dataâ€¦</pre>
    </section>
  </main>

  <script>
    const output = document.getElementById('output');
    const workProgress = document.getElementById('work-progress');
    let autoRefreshInterval = null;

    function showResult(data) {
      output.textContent = JSON.stringify(data, null, 2);
    }

    async function request(endpoint, options = {}) {
      try {
        const res = await fetch(endpoint, {
          headers: {
            'Content-Type': 'application/json',
          },
          ...options
        });
        const data = await res.json();
        showResult(data);
        return data;
      } catch (error) {
        showResult({ error: error.message || 'Request failed' });
        return null;
      }
    }

    function showWorkProgress(stats) {
      if (!stats) {
        workProgress.innerHTML = '<div class="loading">Failed to load work stats</div>';
        return;
      }

      if (stats.passwordFound) {
        workProgress.innerHTML = `
          <div class="password-found">
            <h3>ðŸŽ‰ PASSWORD FOUND! ðŸŽ‰</h3>
            <p>The distributed search has successfully found the password!</p>
          </div>
        `;
        return;
      }

      const checkedPercent = stats.total > 0 ? (stats.checked / stats.total * 100) : 0;
      const checkingPercent = stats.total > 0 ? (stats.checking / stats.total * 100) : 0;
      const uncheckPercent = stats.total > 0 ? (stats.uncheck / stats.total * 100) : 0;

      workProgress.innerHTML = `
        <div class="progress-container">
          <div class="progress-bar">
            <div class="progress-segments">
              <div class="progress-segment progress-checked" style="width: ${checkedPercent}%">
                ${checkedPercent > 10 ? `${checkedPercent.toFixed(1)}%` : ''}
              </div>
              <div class="progress-segment progress-checking" style="width: ${checkingPercent}%">
                ${checkingPercent > 10 ? `${checkingPercent.toFixed(1)}%` : ''}
              </div>
              <div class="progress-segment progress-uncheck" style="width: ${uncheckPercent}%">
                ${uncheckPercent > 10 ? `${uncheckPercent.toFixed(1)}%` : ''}
              </div>
            </div>
          </div>
          
          <div class="stats-grid">
            <div class="stat-card stat-checked">
              <div class="stat-number">${stats.checked.toLocaleString()}</div>
              <div class="stat-label">Checked</div>
            </div>
            <div class="stat-card stat-checking">
              <div class="stat-number">${stats.checking.toLocaleString()}</div>
              <div class="stat-label">Checking</div>
            </div>
            <div class="stat-card stat-uncheck">
              <div class="stat-number">${stats.uncheck.toLocaleString()}</div>
              <div class="stat-label">Uncheck</div>
            </div>
            <div class="stat-card stat-total">
              <div class="stat-number">${stats.total.toLocaleString()}</div>
              <div class="stat-label">Total</div>
            </div>
          </div>
          
          <div class="last-updated">
            Last updated: ${new Date().toLocaleTimeString()}
            ${stats.timeout > 0 ? `â€¢ ${stats.timeout} timeout(s)` : ''}
          </div>
        </div>
      `;
    }

    async function loadWorkStats() {
      try {
        const res = await fetch('/work/stats', {
          headers: {
            'Content-Type': 'application/json',
          }
        });
        const stats = await res.json();

        showWorkProgress(stats);

        // Show/hide reset button based on database type
        const resetBtn = document.getElementById('reset-found-btn');
        if (stats && stats.resetAllowed) {
          resetBtn.style.display = 'block';
        } else {
          resetBtn.style.display = 'none';
        }

        // If password found, stop auto refresh
        if (stats && stats.passwordFound) {
          if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
            autoRefreshInterval = null;
            console.log('Password found! Stopped auto refresh.');
          }
        }

        return stats;
      } catch (error) {
        showWorkProgress(null);
        return null;
      }
    }

    function startAutoRefresh() {
      // Clear any existing interval
      if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
      }

      // Set up auto refresh every 30 seconds
      autoRefreshInterval = setInterval(async () => {
        console.log('Auto refreshing work stats...');
        await loadWorkStats();
      }, 30000);
    }

    // Load work stats immediately when page loads
    document.addEventListener('DOMContentLoaded', async () => {
      console.log('Loading initial work stats...');
      const stats = await loadWorkStats();

      // Start auto refresh if password not found
      if (!stats || !stats.passwordFound) {
        startAutoRefresh();
        console.log('Started auto refresh (every 30 seconds)');
      }
    });

    document.addEventListener('click', (event) => {
      if (!(event.target instanceof HTMLButtonElement)) return;
      const action = event.target.dataset.action;
      if (!action) return;

      if (action === 'count') {
        request('/count');
      } else if (action === 'random') {
        request('/records/random');
      } else if (action === 'health') {
        request('/health');
      } else if (action === 'by-id') {
        const idValue = document.getElementById('id-input').value.trim();
        if (!idValue) {
          showResult({ error: 'Please enter an ID' });
          return;
        }
        request(`/records/${encodeURIComponent(idValue)}`);
      } else if (action === 'by-pwd') {
        const pwdValue = document.getElementById('pwd-input').value.trim();
        if (!pwdValue) {
          showResult({ error: 'Please enter a pwd' });
          return;
        }
        request(`/records/by-pwd/${encodeURIComponent(pwdValue)}`);
      } else if (action === 'stats') {
        loadWorkStats().then(stats => {
          // Restart auto refresh if password not found
          if (!stats || !stats.passwordFound) {
            startAutoRefresh();
          }
        });
      } else if (action === 'reset-found') {
        if (confirm('Are you sure you want to reset the password found status? This will restart the entire search process.')) {
          request('/work/reset-found', { 
            method: 'POST',
            body: JSON.stringify({}) 
          }).then(() => {
            // Reload work stats after reset
            loadWorkStats().then(stats => {
              if (!stats || !stats.passwordFound) {
                startAutoRefresh();
              }
            });
          });
        }
      }
    });
  </script>
</body>

</html>